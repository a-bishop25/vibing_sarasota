<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Vibing Sarasota</title>
    <meta name="theme-color" content="#1E3A8A">

    <!-- Fonts & Styles -->
    <link href="../fonts.googleapis.com/css239d4.css?family=Roboto:wght@400;700&amp;family=Open+Sans:wght@400;600&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<!-- Navigation -->
<nav class="main-navigation">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="index-2.html" class="brand-link">
                <span class="brand-icon">üå¥</span>
                <span class="brand-text">Vibing Sarasota</span>
            </a>
        </div>
        <div class="nav-links desktop-nav">
            <a href="index-2.html" class="nav-link">All Categories</a>
            <a href="signup.html" class="nav-link">Sign Up</a>
            <a href="login.html" class="nav-link active">Login</a>
        </div>
        <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
            <span></span><span></span><span></span>
        </button>
    </div>
</nav>

<div class="container">
    <header class="category-header">
        <div class="category-icon">üîë</div>
        <h1>Login</h1>
        <p>Access your account to explore Sarasota‚Äôs best local businesses and manage your favorites.</p>
    </header>

    <main class="form-section">
        <form id="login-form" class="login-form">
            <label>
                Username:<br>
                <input type="text" name="username" required>
            </label><br>
            <label>
                Password:<br>
                <input type="password" name="password" required>
            </label><br>
            <button type="submit" class="btn-primary">Log In</button>
        </form>

        <p class="signup-link">Don't have an account? <a href="signup.html">Sign up here</a>.</p>
        <p id="message"></p>
    </main>
</div>

<!-- Footer -->
<footer class="site-footer">
    <div class="footer-container">
        <div class="footer-content">
            <div class="footer-brand">
                <h3>Vibing Sarasota</h3>
                <p>Discover the best local businesses in Sarasota through questions answered like a local friend would.</p>
            </div>
            <div class="footer-links">
                <h4>Other Pages</h4>
                <ul>
                    <li><a href="index-2.html">All Categories</a></li>
                    <li><a href="signup.html">Sign Up</a></li>
                    <li><a href="login.html">Login</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Vibing Sarasota. All rights reserved.</p>
        </div>
    </div>
</footer>

<!-- JavaScript -->
<script>
    const form = document.getElementById("login-form");
    const message = document.getElementById("message");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch("/api/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await res.json();
            console.log("Server response:", result);

            if (res.ok) {
                // ‚úÖ Always create a user object to store in localStorage
                let userToStore = {};

                if (result.user) {
                    userToStore = result.user;
                } else if (result.id || result.username) {
                    userToStore = {
                        _id: result.id || null,
                        displayName: result.username || "Unknown User"
                    };
                } else {
                    userToStore = { _id: null, displayName: "Unknown User" };
                }

                // Save to localStorage
                localStorage.setItem("user", JSON.stringify(userToStore));
                console.log("Saved user in localStorage:", userToStore);

                // Show success message
                message.textContent = "‚úÖ Login successful! Welcome, " + userToStore.displayName;

                // Redirect after short delay
                setTimeout(() => {
                    window.location.href = "index-2.html";
                }, 500);

            } else {
                message.textContent = "‚ùå Error: " + result.error;
            }

        } catch (err) {
            message.textContent = "‚ùå Network error";
            console.error(err);
        }
    });

    // Check on page load if user is already in localStorage
    const storedUser = localStorage.getItem("user");
    if (storedUser) {
        console.log("User is saved in localStorage on page load:", JSON.parse(storedUser));
    } else {
        console.log("No user found in localStorage!");
    }
</script>

</body>
</html>
